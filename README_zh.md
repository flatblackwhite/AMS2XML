# å›¾åƒè½¬ DrawIO (XML) è½¬æ¢å™¨ (Image to DrawIO Converter)

æœ¬é¡¹ç›®å®ç°äº†ä¸€å¥—ç²¾å¯†çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼Œåˆ©ç”¨å…ˆè¿›çš„è®¡ç®—æœºè§†è§‰æ¨¡å‹å’Œå¤šæ¨¡æ€å¤§è¯­è¨€æ¨¡å‹ï¼Œå°†é™æ€å›¾åƒï¼ˆå¦‚æµç¨‹å›¾ã€æ¶æ„å›¾ã€æŠ€æœ¯ç»˜å›¾ï¼‰è½¬æ¢ä¸ºå¯ç¼–è¾‘çš„ DrawIO (mxGraph) XML æ–‡ä»¶ï¼Œå®ç°é«˜ä¿çœŸçš„é€†å‘å·¥ç¨‹ä¸é‡å»ºã€‚

[English README](README.md)

## æ ¸å¿ƒåŠŸèƒ½

*   **å…ˆè¿›åˆ†å‰²æŠ€æœ¯ (Advanced Segmentation)**: é‡‡ç”¨ **SAM 3 (Segment Anything Model 3)** æ¨¡å‹ï¼Œå¯¹å›¾è¡¨å…ƒç´ ï¼ˆåŸºç¡€å½¢çŠ¶ã€ç®­å¤´ã€å›¾æ ‡ï¼‰è¿›è¡Œ SOTA çº§åˆ«çš„ç²¾å‡†åˆ†å‰²ã€‚
*   **å›ºå®šå››è½®è¿­ä»£æ‰«æ (Fixed 4-Round VLM Scanning)**: å¼•å…¥ **å¤šæ¨¡æ€å¤§æ¨¡å‹ (Qwen-VL/GPT-4V)** è¿›è¡Œå››è½®ç»“æ„åŒ–æ‰«æï¼Œå½»åº•æœç»å…ƒç´ é—æ¼ï¼š
    1.  **åˆå§‹å…¨é‡æå–**: è¯†åˆ«åŸºç¡€å½¢çŠ¶ä¸å›¾æ ‡ã€‚
    2.  **å•è¯æŸ¥æ¼ (Single Word Round)**: æ‰«ææœªè¯†åˆ«åŒºåŸŸçš„å•ä¸€ç‰©ä½“ã€‚
    3.  **åŒè¯ç²¾ä¿® (Two-Word Round)**: é’ˆå¯¹ç‰¹å®šå±æ€§æˆ–ç½•è§ç‰©ä½“è¿›è¡Œæå–ã€‚
    4.  **çŸ­è¯­è¡¥å…¨ (Phrase Round)**: è¯†åˆ«å¤æ‚ç»„åˆæˆ–é•¿æè¿°ç‰©ä½“ã€‚
*   **é«˜è´¨é‡ OCR ä¸å…¬å¼è¯†åˆ«**:
    *   **Azure Document Intelligence**: æä¾›å·¥ä¸šçº§çš„ç²¾å‡†æ–‡æœ¬å®šä½ï¼ˆBounding Boxï¼‰ã€‚
    *   **Mistral Vision/MLLM**: ä¸“é—¨ç”¨äºæ ¡å¯¹æ–‡æœ¬å†…å®¹ï¼Œèƒ½å¤Ÿå°†å¤æ‚çš„æ•°å­¦å…¬å¼ç²¾ç¡®è½¬æ¢ä¸º **LaTeX** æ ¼å¼ï¼ˆä¾‹å¦‚ $\int f(x) dx$ï¼‰ï¼Œå¹¶åœ¨ DrawIO ä¸­å®Œç¾æ¸²æŸ“ã€‚
    *   **å±€éƒ¨è£å‰ªç­–ç•¥ (Crop-Guided Strategy)**: å°†æ–‡æœ¬/å…¬å¼åŒºåŸŸè£å‰ªä¸ºé«˜æ¸…å°å›¾å‘é€ç»™ LLMï¼Œä»æ ¹æœ¬ä¸Šè§£å†³äº†å°å­—å·æ¨¡ç³Šå’Œå…¬å¼ä¹±ç é—®é¢˜ã€‚
*   **æ™ºèƒ½èƒŒæ™¯ç§»é™¤ (Smart Background Removal)**: é›†æˆ **RMBG-2.0** æ¨¡å‹ï¼Œè‡ªåŠ¨å¯¹å›¾æ ‡ã€å›¾ç‰‡å’Œç®­å¤´è¿›è¡Œç²¾ç»†æŠ å›¾ï¼ˆå»èƒŒï¼‰ï¼Œç¡®ä¿å®ƒä»¬åœ¨ DrawIO ä¸­å¯ä»¥å®Œç¾å åŠ ï¼Œæ— ç™½è‰²èƒŒæ™¯å¹²æ‰°ã€‚
*   **é«˜ä¿çœŸç®­å¤´å¤„ç†**: æ‘’å¼ƒäº†ä¸ç¨³å®šçš„çŸ¢é‡åŒ–è·¯å¾„ç”Ÿæˆï¼Œå°†ç®­å¤´ä½œä¸ºé€æ˜å›¾åƒæå–ã€‚è¿™ç§æ–¹æ³•èƒ½å®Œç¾ä¿ç•™è™šçº¿ã€æ›²çº¿ã€å¤æ‚çš„è·¯ç”±èµ°å‘å’Œç«¯ç‚¹æ ·å¼ï¼Œå®ç°äº†è§†è§‰ä¸Šçš„ç»å¯¹ä¸€è‡´ã€‚
*   **çŸ¢é‡å½¢çŠ¶æ¢å¤**: æ ‡å‡†å‡ ä½•å½¢çŠ¶ä¼šè¢«è¯†åˆ«å¹¶è½¬æ¢ä¸ºåŸç”Ÿçš„ DrawIO çŸ¢é‡å¯¹è±¡ï¼Œå¹¶è‡ªåŠ¨æå–å¡«å……è‰²å’Œæè¾¹è‰²ã€‚
    *   **æ”¯æŒå½¢çŠ¶**: çŸ©å½¢ã€åœ†è§’çŸ©å½¢ã€è±å½¢(Decision)ã€æ¤­åœ†(Start/End)ã€åœ†æŸ±(Database)ã€äº‘ã€å…­è¾¹å½¢ã€ä¸‰è§’å½¢ã€å¹³è¡Œå››è¾¹å½¢ã€å°äºº(Actor)ã€æ ‡é¢˜æ (Title Bar)ã€æ–‡æœ¬æ°”æ³¡(Text Bubble)ã€åˆ†ç»„æ¡†(Section Panel)ã€‚
*   **å¤šç”¨æˆ·å¹¶å‘æ”¯æŒ (Multi-User Concurrency)**: é€šè¿‡ **å…¨å±€é” (Global Lock)** å’Œ **LRU ç¼“å­˜ (LRU Cache)** æœºåˆ¶ï¼Œå®ç°çº¿ç¨‹å®‰å…¨çš„ GPU èµ„æºç®¡ç†ã€‚ç³»ç»Ÿèƒ½é«˜æ•ˆå¤„ç†å¤šç”¨æˆ·å¹¶å‘è¯·æ±‚ï¼Œå¤ç”¨å›¾åƒç‰¹å¾ç¼–ç ï¼Œå¹¶åœ¨ä¿è¯æ˜¾å­˜å®‰å…¨çš„åŒæ—¶æ˜¾è‘—æå‡å“åº”é€Ÿåº¦ã€‚
*   **å…¨æ ˆ Web ç•Œé¢**: æä¾›åŸºäº React çš„ç°ä»£åŒ–å‰ç«¯å’Œ FastAPI åç«¯ï¼Œæ”¯æŒæ‹–æ‹½ä¸Šä¼ ã€è¿›åº¦å®æ—¶æ˜¾ç¤ºå’Œåœ¨çº¿ç¼–è¾‘é¢„è§ˆã€‚

## æ¶æ„æµç¨‹

1.  **è¾“å…¥**: å›¾åƒæ–‡ä»¶ (PNG/JPG)ã€‚
2.  **åˆ†å‰² (SAM3)**:
    *   é¦–è½®æå–ï¼šä½¿ç”¨æ ‡å‡†æç¤ºè¯ï¼ˆrectangle, arrow, iconï¼‰è¿›è¡Œå…¨å›¾æ‰«æã€‚
    *   è¿­ä»£å¾ªç¯ï¼šè®¡ç®—æœªè¯†åˆ«åŒºåŸŸæ¯”ä¾‹ -> è¯·æ±‚ MLLM è§‚å¯Ÿæ©ç å›¾ -> è·å–æ–°æç¤ºè¯ -> é‡æ–°è¿è¡Œ SAM3 è§£ç å™¨ã€‚
3.  **å…ƒç´ å¤„ç†**:
    *   **çŸ¢é‡å½¢çŠ¶**: æå–é¢œè‰²ï¼ˆå¡«å……/æè¾¹ï¼‰ï¼Œæ˜ å°„ä¸º DrawIO XML å‡ ä½•ä½“ã€‚
    *   **å›¾åƒå…ƒç´  (å›¾æ ‡/ç®­å¤´)**: åæ ‡è£å‰ª -> æ™ºèƒ½ Padding -> Mask è¿‡æ»¤ -> RMBG-2.0 å»èƒŒ -> Base64 ç¼–ç ã€‚
4.  **æ–‡æœ¬æå– (å¹¶è¡Œå¤„ç†)**:
    *   Azure OCR æ£€æµ‹æ–‡æœ¬åŒ…å›´ç›’ã€‚
    *   å¯¹æ¯ä¸ªæ–‡æœ¬åŒºåŸŸè¿›è¡Œé«˜æ¸…è£å‰ªã€‚
    *   Mistral/LLM è¯†åˆ«å†…å®¹å¹¶åˆ¤æ–­æ˜¯å¦ä¸ºå…¬å¼ï¼ˆè½¬ LaTeXï¼‰ã€‚
5.  **XML ç”Ÿæˆ**:
    *   åˆå¹¶ SAM3 çš„ç©ºé—´æ•°æ®ä¸ OCR çš„æ–‡æœ¬æ•°æ®ã€‚
    *   åº”ç”¨ Z-Index å±‚çº§æ’åºï¼ˆå¤§é¢ç§¯å½¢çŠ¶ç½®åº•ï¼Œæ–‡å­—å’Œè¿çº¿ç½®é¡¶ï¼‰ã€‚
    *   ç”Ÿæˆæœ€ç»ˆçš„ `.drawio.xml` æ–‡ä»¶ã€‚

## é¡¹ç›®ç»“æ„

```
sam3_workflow/
â”œâ”€â”€ config/                 # é…ç½®æ–‡ä»¶
â”œâ”€â”€ flowchart_text/         # OCR ä¸æ–‡æœ¬æå–æ¨¡å—
â”‚   â”œâ”€â”€ src/                # OCR æ ¸å¿ƒä»£ç  (Azure, Mistral, æ–‡æœ¬å¯¹é½)
â”‚   â””â”€â”€ main.py             # OCR å…¥å£ç¨‹åº
â”œâ”€â”€ frontend/               # React å‰ç«¯åº”ç”¨
â”œâ”€â”€ input/                  # [éœ€æ‰‹åŠ¨åˆ›å»º] è¾“å…¥å›¾ç‰‡ç›®å½•
â”œâ”€â”€ models/                 # [éœ€æ‰‹åŠ¨åˆ›å»º] æ¨¡å‹æƒé‡ç›®å½•
â”‚   â””â”€â”€ rmbg/               # [éœ€æ‰‹åŠ¨åˆ›å»º] RMBGæ¨¡å‹
â”œâ”€â”€ output/                 # [éœ€æ‰‹åŠ¨åˆ›å»º] è¾“å‡ºç»“æœç›®å½•
â”œâ”€â”€ sam3/                   # SAM3 æ¨¡å‹åº“
â”œâ”€â”€ scripts/                # æ ¸å¿ƒå¤„ç†è„šæœ¬
â”‚   â”œâ”€â”€ sam3_extractor.py   # åˆ†å‰²ä¸å›¾åƒæå–é€»è¾‘ (SAM3 + RMBG)
â”‚   â”œâ”€â”€ merge_xml.py        # XML åˆå¹¶ä¸æµç¨‹ç¼–æ’
â”‚   â””â”€â”€ run_all.py          # å‘½ä»¤è¡Œå…¥å£ (CLI)
â”œâ”€â”€ server.py               # FastAPI åç«¯æœåŠ¡
â””â”€â”€ requirements.txt        # Python ä¾èµ–åˆ—è¡¨
```

## ğŸ› ï¸ å®‰è£…ä¸éƒ¨ç½²æŒ‡å— (Installation Guide)

### 1. ç¯å¢ƒå‡†å¤‡
*   **Python 3.10+**
*   **Node.js & npm** (å‰ç«¯è¿è¡Œéœ€è¦)
*   **NVIDIA GPU** (å¼ºçƒˆæ¨èï¼Œç”¨äºåŠ é€Ÿ SAM3 å’Œ RMBG æ¨ç†)

### 2. å…‹éš†ä»£ç ä»“åº“
```bash
git clone https://github.com/DB-121143/IMG2XML.git
cd IMG2XML/sam3_workflow
```

### 3. åˆå§‹åŒ–æ–‡ä»¶å¤¹ç»“æ„ (Initialize Folders)
ç”±äº Git å¿½ç•¥äº†å¤§æ–‡ä»¶å’Œä¸´æ—¶ç›®å½•ï¼Œ**æ‹‰å–ä»£ç åå¿…é¡»æ‰‹åŠ¨åˆ›å»ºä»¥ä¸‹æ–‡ä»¶å¤¹**ï¼š

```bash
# åˆ›å»ºè¾“å…¥è¾“å‡ºç›®å½•
mkdir -p input
mkdir -p output
mkdir -p sam3_output

# åˆ›å»ºæ¨¡å‹å­˜æ”¾ç›®å½•
mkdir -p models/rmbg
```

### 4. ä¸‹è½½æ¨¡å‹æƒé‡ (Download Models)
è¯·ä¸‹è½½å¯¹åº”çš„æ¨¡å‹æ–‡ä»¶å¹¶æ”¾å…¥æŒ‡å®šç›®å½•ï¼š

| æ¨¡å‹åç§° (Model) | ç”¨é€” | ä¸‹è½½é“¾æ¥ | ç›®æ ‡è·¯å¾„ (Target Path) |
| :--- | :--- | :--- | :--- |
| **RMBG-2.0** | èƒŒæ™¯ç§»é™¤ (å»åº•) | [RMBG-2.0](https://modelscope.cn/models/AI-ModelScope/RMBG-2.0/tree/master/onnx) | `models/rmbg/model.onnx` |
| **SAM 3** | å›¾åƒåˆ†å‰² | https://modelscope.cn/models/facebook/sam3 | `models/sam3.pt` (éœ€åœ¨é…ç½®ä¸­æŒ‡å®š) |

> âš ï¸ **æ³¨æ„**: `models/rmbg` æ–‡ä»¶å¤¹ä¸‹å¿…é¡»åŒ…å« `model.onnx` æ–‡ä»¶ã€‚

### 5. å®‰è£…ä¾èµ– (Dependencies)

**åç«¯:**
```bash
pip install -r requirements.txt
```

**å‰ç«¯:**
```bash
cd frontend
npm install
cd ..
```

### 6. é…ç½®æ–‡ä»¶ (Configuration)

**1. å¤åˆ¶é…ç½®æ–‡ä»¶**
```bash
cp config/config.yaml.example config/config.yaml
```

**2. é…ç½®ç¯å¢ƒå˜é‡ (.env)**
åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼Œå¡«å…¥å¿…è¦çš„ API å¯†é’¥ï¼š
```env
AZURE_ENDPOINT=https://your-resource.cognitiveservices.azure.com/
AZURE_API_KEY=your_azure_key
# å…¶ä»–å¸¸ç”¨ Key
# OPENAI_API_KEY=...
# DASHSCOPE_API_KEY=...
```

## ä½¿ç”¨æŒ‡å—

### 1. Web ç•Œé¢ (æ¨è)

å¯åŠ¨åç«¯æœåŠ¡:
```bash
python server.py
# æœåŠ¡è¿è¡Œåœ¨ http://localhost:8000
```

å¯åŠ¨å‰ç«¯ç•Œé¢:
```bash
cd frontend
npm install
npm run dev
# ç•Œé¢è¿è¡Œåœ¨ http://localhost:5173
```
æ‰“å¼€æµè§ˆå™¨è®¿é—®å‰ç«¯åœ°å€ï¼Œä¸Šä¼ å›¾ç‰‡å³å¯æŸ¥çœ‹è½¬æ¢ç»“æœã€‚

### 2. å‘½ä»¤è¡Œå·¥å…· (CLI)

å¤„ç†å•å¼ å›¾ç‰‡:

```bash
python scripts/run_all.py --image input/test_diagram.png
```
ç”Ÿæˆçš„ XML æ–‡ä»¶å°†ä¿å­˜åœ¨ `output/` ç›®å½•ä¸‹ã€‚

## é…ç½®è¯´æ˜ `config.yaml`

æ‚¨å¯ä»¥åœ¨ `config/config.yaml` ä¸­è‡ªå®šä¹‰æµæ°´çº¿çš„è¡Œä¸ºï¼š
*   **sam3**: è°ƒæ•´ç½®ä¿¡åº¦é˜ˆå€¼ (score_threshold)ã€NMS é‡å é˜ˆå€¼ã€æœ€å¤§è¿­ä»£æ¬¡æ•°ã€‚
*   **paths**: è®¾ç½®è¾“å…¥/è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„ã€‚
*   **dominant_color**: å¾®è°ƒé¢œè‰²æå–çš„æ•æ„Ÿåº¦å’Œç­–ç•¥ã€‚

